<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Infinity heroes kingdom map</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        .main {
            width: 100%;
            display: flex;
            flex-direction: row;
        }
        #app {
            height: 100vh;
            overflow: scroll;
            flex: 4 1 0;
        }
        .control {
            background: red;
            width: 240px;
            flex: 1 1 0;
        }
        .resource-wrapper {
            display: inline-block;
            float: left;
            width: 50%;
        }
        .resource-wrapper form input {
            width: 32px;
        }
        table {
            border-collapse: collapse;
        }
        table tr td, table tr th {
            border: 1px solid #000;
        }
    </style>

    <script src="dragscroll.js"></script>
</head>

<body>

    <div class="main">
        <div class="control">
            <h1>GermanWings</h1>
            <div>Season : 21</div>
            <div class="resource-wrapper">
                <h3>Ruin</h3>
                <form data-type="ruin" class="resource-form">
                    <input type="text" name="x">
                    <input type="text" name="y">
                    <button type="submit">+</button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>x</th>
                            <th>y</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>322</td>
                            <td>314</td>
                            <td>x</td>
                       </tr>
                    </tbody>
                </table>
            </div>

            <div class="resource-wrapper">
                <h3>Oasis</h3>
                <form data-type="oasis" class="resource-form">
                    <input type="text" name="x">
                    <input type="text" name="y">
                    <button type="submit">+</button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>X</th>
                            <th>Y</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>322</td>
                            <td>314</td>
                            <td>x</td>
                       </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dragscroll" id="app">
            <canvas id="map"></canvas>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
	<script src="./data/seasons/22.js"></script>

	<script type="text/javascript">
        var App = function (config) {

            var mapSize = 100, mapWidth = 6400, mapHeight = 3200;
            var tileWidth, tileHeight, canvas, ctx, mapData, resourceAssets, sprite;

            this.run = function () {
                var $this = this;
                this.init();

                sprite.onload = function () {
                    $this.draw();
                }
            };

            this.init = function () {
                canvas = document.getElementById('map');
                ctx = canvas.getContext('2d');
                canvas.width = mapWidth + 100;
                canvas.height = mapHeight + 100;
                ctx.translate(canvas.width / 2, 0);

                tileWidth = mapWidth / mapSize;
                tileHeight = mapHeight / mapSize;

                mapData = config.mapData;
                resourceAssets = {
                    'oasis': [111, 814, 123, 79],
                    'ruin': [2, 802, 103, 91],
                };

                sprite = new Image();
                sprite.src = './data/sprite.png';
            }

            this.draw = function() {
                var x = 0;
                var y = 0;

                for (let i = 0; i < mapSize; i++) {
                    y = i * tileHeight / 2;
                    for (let j = 0; j < mapSize; j++) {
                        let tileCoordinate = getTile(mapData.map[i][j]);

                        ctx.drawImage(
                            sprite,
                            tileCoordinate[0],
                            tileCoordinate[1],
                            64,
                            82,
                            x - j * tileWidth/2,
                            y + tileHeight/2 - (mapData.high[i][j]*2),
                            64,
                            82
                        );

                        let coord = checkAsset(i, j);
                        if (coord !== false) {
                            ctx.drawImage(
                                sprite,
                                coord[0],
                                coord[1],
                                coord[2],
                                coord[3],
                                x - j * tileWidth / 2 + 5,
                                y + tileHeight / 2 - (mapData.high[i][j] * 2) - 13,
                                50,
                                44
                            );
                        }
                        y += tileHeight / 2;
                    }
                    x += tileWidth / 2;
                }
                document.getElementById('app').scrollLeft = 3000;
            };

            var checkAsset = function(x, y) {
                var resources = getResources();
                for (let resource in resources) {
                    if (resources.hasOwnProperty(resource)) {
                        for (let i = 0; i < resources[resource].length; i++) {
                            if (resources[resource][i][0] === x && resources[resource][i][1] === y) {
                                return resourceAssets[resource];
                            }
                        }
                    }
                }

                return false;
            }

            var getResources = function() {
                return {
                    'oasis': [

                    ],
                    'ruin': [

                    ]
                };
            }

            var getTile = function (tileId) {
                return mapping = {
                    1: [414, 943],
                    10: [638, 738],
                    11: [356, 558],
                    12: [494, 859],
                    13: [638, 905],
                    14: [638, 905],
                    20: [566, 906],
                    21: [740, 943],
                    22: [884, 944],
                    23: [647, 570],
                    24: [484, 943],
                    25: [859, 859],
                    30: [638, 820],
                    31: [282, 564],
                    32: [575, 531],
                    33: [712, 858],
                    34: [484, 943],
                    40: [429, 558],
                    41: [812, 943],
                    42: [533, 673],
                    43: [785, 857],
                    44: [502, 588],
                    45: [930, 858],
                    46: [710, 775],
                    50: [566, 822],
                    51: [494, 775],
                    52: [607, 655],
                    53: [679, 655],
                }[tileId];
            }
        };

        window.onload = function () {
            var app = new App({mapData: mapData.items});
            app.run();

            var forms = document.getElementsByClassName('resource-form');
            console.log(forms.length);
            for (let i = 0; i < forms.length; i++) {
                forms[i].addEventListener('submit', function(event) {
                    event.preventDefault();
                    var formData = new FormData(this);
                    console.log(formData.get('x'));
                    console.log(this.dataset.type);
                });
            }
        }

	</script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-37232412-23"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-37232412-23');
  </script>

</body>

</html>