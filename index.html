<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Infinity heroes kingdom map</title>
    <style>
        #app {
            display: block;
            width: calc(100vw - 322px);
            height: 96vh;
            overflow: scroll;
            float: right;
        }
    </style>

    <script src="dragscroll.js"></script>
</head>

<body>

    <div class="dragscroll" id="app">
        <canvas id="map"></canvas>
    </div>


	<script src="map.js"></script>

	<script type="text/javascript">
        var App = function (config) {

            var mapSize = 100, mapWidth = 6400, mapHeight = 3200;
            var tileWidth, tileHeight, canvas, ctx, mapData, resourceAssets, sprite;

            this.run = function () {
                var $this = this;
                this.init();

                sprite.onload = function () {
                    $this.draw();
                }
            };

            this.init = function () {
                canvas = document.getElementById('map');
                ctx = canvas.getContext('2d');
                canvas.width = mapWidth + 100;
                canvas.height = mapHeight + 100;
                ctx.translate(canvas.width / 2, 0);

                tileWidth = mapWidth / mapSize;
                tileHeight = mapHeight / mapSize;

                mapData = config.mapData;
                resourceAssets = {
                    'oasis': [111, 814, 123, 79],
                    'ruin': [2, 802, 103, 91],
                };

                sprite = new Image();
                sprite.src = './data/sprite.png';
            }

            this.draw = function() {
                console.log('in draw');
                var x = 0;
                var y = 0;

                for (let i = 0; i < mapSize; i++) {
                    y = i * tileHeight / 2;
                    for (let j = 0; j < mapSize; j++) {
                        let tileCoordinate = getTile(mapData.map[i][j]);

                        // ctx.fillStyle = 'red';
                        // ctx.fillRect(x - j * tileWidth / 2, y + tileHeight / 2 - (mapData.high[i][j] * 2), 64,32)

                        ctx.drawImage(
                            sprite,
                            tileCoordinate[0],
                            tileCoordinate[1],
                            64,
                            82,
                            x - j * tileWidth/2,
                            y + tileHeight/2 - (mapData.high[i][j]*2),
                            64,
                            82
                        );

                        let coord = checkAsset(i, j);
                        if (coord !== false) {
                            console.log(coord);
                            ctx.drawImage(
                                sprite,
                                coord[0],
                                coord[1],
                                coord[2],
                                coord[3],
                                x - j * tileWidth / 2 + 5,
                                y + tileHeight / 2 - (mapData.high[i][j] * 2) - 13,
                                50,
                                44
                            );
                        }
                        y += tileHeight / 2;
                    }
                    x += tileWidth / 2;
                }
                document.getElementById('app').scrollLeft = 3000;
            };

            var checkAsset = function(x, y) {
                var resources = getResources();
                for (let resource in resources) {
                    if (resources.hasOwnProperty(resource)) {
                        for (let i = 0; i < resources[resource].length; i++) {
                            if (resources[resource][i][0] === x && resources[resource][i][1] === y) {
                                return resourceAssets[resource];
                            }
                        }
                    }
                }

                return false;
            }

            var getResources = function() {
                return {
                    'oasis': [
                       [5,13],
                       [5, 17],
                       [10,17],
                       [13,17],
                       [4,23],
                       [7,23],
                       [17,10],
                    ],
                    'ruin': [
                        [8,13],
                        [10,17],
                        [11,14],
                        [14,16],
                        [2,23],
                        [8,22],
                        [18,11],
                        [8,27],
                        [21,7],
                    ]
                };
            }

            var getTile = function (tileId) {
                return mapping = {
                    1: [414, 943],
                    10: [638, 738],
                    11: [356, 558],
                    12: [494, 859],
                    13: [638, 905],
                    14: [638, 905],
                    20: [566, 906],
                    21: [740, 943],
                    22: [884, 944],
                    23: [647, 570],
                    24: [484, 943],
                    25: [859, 859],
                    30: [638, 820],
                    31: [282, 564],
                    32: [575, 531],
                    33: [712, 858],
                    34: [484, 943],
                    40: [429, 558],
                    41: [812, 943],
                    42: [533, 673],
                    43: [785, 857],
                    44: [502, 588],
                    45: [930, 858],
                    46: [710, 775],
                    50: [566, 822],
                    51: [494, 775],
                    52: [607, 655],
                    53: [679, 655],
                }[tileId];
            }
        };

        window.onload = function () {
            var app = new App({mapData: mapData.items});
            app.run();
        }

	</script>
</body>

</html>